name: Update IPTV Sources

on:
  # 1. å®šæ—¶ä»»åŠ¡ï¼šè´Ÿè´£æ£€æŸ¥è¿œç¨‹ unicast-ku9.m3u å˜åŒ–
  schedule:
    - cron: '0 */4 * * *'
  
  # 2. æ‰‹åŠ¨è§¦å‘ï¼šå½“ä½ ä¿®æ”¹äº† multicast-origin.m3u åï¼Œè‡ªåŠ¨è§¦å‘
  push:
    paths:
      - '.github/expand/multicast-origin.m3u'
      - 'scripts/update_catchup_source.py'
      - 'scripts/expand_multicast.py'

  # 3. æ‰‹åŠ¨å¼ºåˆ¶è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥æ‰€æœ‰å“ˆå¸Œæ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update-and-expand:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout public repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout private repository (Hidden Logic)
        uses: actions/checkout@v4
        with:
          repository: sggc/SDU-IPTV-NEW
          path: private_repo
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # ================= ç¬¬ä¸€æ­¥ï¼šæ›´æ–° Catchup æº =================
      - name: Step 1: Update Catchup Source (Origin -> Merge)
        env:
          FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ Step 1: æ›´æ–° Catchup æº..."
          python scripts/update_catchup_source.py

      # ================= ç¬¬äºŒæ­¥ï¼šæ‰©å±•å¤šæ’­æº =================
      - name: Step 2: Expand Multicast Sources (Merge -> Expand)
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ Step 2: æ‰©å±•å¤šæ’­æº..."
          python scripts/expand_multicast.py

      # ================= ç»Ÿä¸€æäº¤ç»“æœ =================
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .github/expand/multicast-merge.m3u
          git add .github/expand/multicast-expand.m3u
          git add .data/catchup_source_hash.txt
          git add .data/expand_hash.txt
          
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡æäº¤..."
            git commit -m "Auto Update IPTV [ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') ]"
            git push
            echo "âœ… æäº¤å¹¶æ¨é€æˆåŠŸï¼"
          fi
