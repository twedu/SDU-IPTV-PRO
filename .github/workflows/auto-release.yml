name: Auto Packaging

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: 

# ============================================
# ðŸ“Œ é…ç½®åŒºåŸŸ - åœ¨æ­¤æ·»åŠ éœ€è¦ç›‘æµ‹çš„æ–‡ä»¶
# ============================================
# å†™æ³•ç¤ºä¾‹ï¼š
#   æ ¹ç›®å½•æ–‡ä»¶ï¼š    unicast.m3u
#   å­ç›®å½•æ–‡ä»¶ï¼š    subdir/example.m3u
#   å¤šå±‚ç›®å½•ï¼š      path/to/file.m3u
# ============================================
env:
  MONITOR_FILES: |
    unicast.m3u
    multicast-r2h.m3u
    multicast-nofcc.m3u
    multicast-static.m3u
# ============================================

permissions:
  contents: write

concurrency:
  group: playlist-update-group
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for file changes
      id: check_changes
      run: |
        LAST_TAG=$(git tag --sort=-creatordate | head -n 1)
        
        if [ -z "$LAST_TAG" ]; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
        else
          CHANGED_FILES=$(git diff --name-only "$LAST_TAG" HEAD 2>/dev/null || echo "")
        fi
        
        echo "Changed files since last release:"
        echo "$CHANGED_FILES"
        
        CHANGED_LIST=""
        while IFS= read -r file; do
          file=$(echo "$file" | xargs)
          [ -z "$file" ] && continue
          if echo "$CHANGED_FILES" | grep -q "^${file}$"; then
            CHANGED_LIST="${CHANGED_LIST}${file}"$'\n'
          fi
        done <<< "$MONITOR_FILES"
        
        if [ -n "$CHANGED_LIST" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "changed_list<<EOF" >> $GITHUB_OUTPUT
          echo -n "$CHANGED_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Skip if no changes
      if: steps.check_changes.outputs.has_changes == 'false'
      run: |
        echo "No monitored file changes detected. Skipping release."

    - name: Get version info
      if: steps.check_changes.outputs.has_changes == 'true'
      id: version
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        export TZ='Asia/Shanghai'
        TODAY=$(date +'%Y%m%d')
        
        # èŽ·å–ä»Šå¤©æœ€å¤§çš„ç‰ˆæœ¬å·ï¼ˆåªæå–çº¯æ•°å­—ï¼‰
        LAST_VERSION=$(gh release list --limit 100 2>/dev/null \
          | grep "å­˜æ¡£${TODAY}-v" \
          | sed 's/.*å­˜æ¡£'"${TODAY}"'-v\([0-9]*\).*/\1/' \
          | grep -E '^[0-9]+$' \
          | sort -nr \
          | head -n 1)
        
        # ç¡®ä¿ LAST_VERSION æ˜¯æœ‰æ•ˆæ•°å­—
        if ! [[ "$LAST_VERSION" =~ ^[0-9]+$ ]]; then
          LAST_VERSION=0
        fi
        
        NEW_VERSION=$((LAST_VERSION + 1))
        NEW_VERSION=${NEW_VERSION:-1}
        
        RELEASE_NAME="å­˜æ¡£${TODAY}-v${NEW_VERSION}"
        
        echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        echo "Release name: $RELEASE_NAME"

    - name: Create archive
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        RELEASE_NAME="${{ steps.version.outputs.release_name }}"
        
        zip -r "${RELEASE_NAME}.zip" . \
          -i "*.m3u" \
          -i "*.py" \
          -i ".github/*" \
          -i ".github/**/*"
        
        echo "Archive created: ${RELEASE_NAME}.zip"
        unzip -l "${RELEASE_NAME}.zip"

    - name: Create Release and Upload Assets
      if: steps.check_changes.outputs.has_changes == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RELEASE_NAME="${{ steps.version.outputs.release_name }}"
        
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        ASSETS="${RELEASE_NAME}.zip"
        CHANGED_LIST="${{ steps.check_changes.outputs.changed_list }}"
        
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          if [ -f "$file" ]; then
            ASSETS="$ASSETS $file"
          fi
        done <<< "$CHANGED_LIST"
        
        echo "Uploading assets: $ASSETS"
        
        NOTES="ðŸ“… æ›´æ–°æ—¶é—´: $BEIJING_TIME"
        NOTES="$NOTES\n\nðŸ“ æœ¬æ¬¡æ›´æ–°çš„æ–‡ä»¶:"
        
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          NOTES="$NOTES\n- $file"
        done <<< "$CHANGED_LIST"
        
        gh release create "$RELEASE_NAME" \
          --title "$RELEASE_NAME" \
          --notes "$(echo -e "$NOTES")" \
          --latest \
          $ASSETS
