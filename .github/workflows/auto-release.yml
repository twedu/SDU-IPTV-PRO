name: Auto Packaging

on:
  schedule:
    # æ¯ä¸ªæ•´ç‚¹æ£€æµ‹ä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´éœ€ +8ï¼‰
    - cron: '0 * * * *'
  workflow_dispatch: 

permissions:
  contents: write

concurrency:
  group: playlist-update-group
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for m3u file changes
      id: check_changes
      run: |
        # è·å–ä¸Šæ¬¡æäº¤å’Œå½“å‰æäº¤ä¹‹é—´çš„å˜åŒ–
        # å¦‚æœæ˜¯é¦–æ¬¡è¿è¡Œæˆ–æ²¡æœ‰ä¸Šæ¬¡ release tagï¼Œåˆ™æ£€æŸ¥æœ€è¿‘ä¸€æ¬¡æäº¤
        
        CHANGED_FILES=""
        HAS_CHANGES="false"
        
        # è·å–æœ€è¿‘ä¸€æ¬¡ release çš„ tag
        LAST_TAG=$(git tag --sort=-creatordate | head -n 1)
        
        if [ -z "$LAST_TAG" ]; then
          # æ²¡æœ‰ä»»ä½• tagï¼Œæ£€æŸ¥æœ€è¿‘ä¸€æ¬¡æäº¤çš„å˜åŒ–
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
        else
          # å¯¹æ¯”ä¸Šæ¬¡ tag åˆ°å½“å‰ HEAD çš„å˜åŒ–
          CHANGED_FILES=$(git diff --name-only "$LAST_TAG" HEAD 2>/dev/null || echo "")
        fi
        
        echo "Changed files since last release:"
        echo "$CHANGED_FILES"
        
        # æ£€æŸ¥ä¸‰ä¸ª m3u æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        UNICAST_CHANGED="false"
        MULTICAST_R2H_CHANGED="false"
        MULTICAST_NOFCC_CHANGED="false"
        
        if echo "$CHANGED_FILES" | grep -q "^unicast.m3u$"; then
          UNICAST_CHANGED="true"
          HAS_CHANGES="true"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "^multicast-r2h.m3u$"; then
          MULTICAST_R2H_CHANGED="true"
          HAS_CHANGES="true"
        fi
        
        if echo "$CHANGED_FILES" | grep -q "^multicast-nofcc.m3u$"; then
          MULTICAST_NOFCC_CHANGED="true"
          HAS_CHANGES="true"
        fi
        
        echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
        echo "unicast_changed=$UNICAST_CHANGED" >> $GITHUB_OUTPUT
        echo "multicast_r2h_changed=$MULTICAST_R2H_CHANGED" >> $GITHUB_OUTPUT
        echo "multicast_nofcc_changed=$MULTICAST_NOFCC_CHANGED" >> $GITHUB_OUTPUT

    - name: Skip if no changes
      if: steps.check_changes.outputs.has_changes == 'false'
      run: |
        echo "No m3u file changes detected. Skipping release."

    - name: Get version info
      if: steps.check_changes.outputs.has_changes == 'true'
      id: version
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        export TZ='Asia/Shanghai'
        TODAY=$(date +'%Y%m%d')
        
        # è·å–ä»Šå¤©æœ€å¤§çš„ç‰ˆæœ¬å·
        LAST_VERSION=$(gh release list --limit 100 | grep "å­˜æ¡£${TODAY}-v" | sed 's/.*å­˜æ¡£'"${TODAY}"'-v\([0-9]*\).*/\1/' | sort -nr | head -n 1)
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç‰ˆæœ¬ï¼Œä» 1 å¼€å§‹
        if [ -z "$LAST_VERSION" ]; then
          NEW_VERSION=1
        else
          NEW_VERSION=$((LAST_VERSION + 1))
        fi
        
        RELEASE_NAME="å­˜æ¡£${TODAY}-v${NEW_VERSION}"
        
        echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        echo "Release name: $RELEASE_NAME"

    - name: Create archive
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        RELEASE_NAME="${{ steps.version.outputs.release_name }}"
        
        # åˆ›å»ºå‹ç¼©åŒ…ï¼ŒåªåŒ…å«æŒ‡å®šæ–‡ä»¶ç±»å‹
        zip -r "${RELEASE_NAME}.zip" . \
          -i "*.m3u" \
          -i "*.py" \
          -i ".github/*" \
          -i ".github/**/*"
        
        echo "Archive created: ${RELEASE_NAME}.zip"
        unzip -l "${RELEASE_NAME}.zip"

    - name: Create Release and Upload Assets
      if: steps.check_changes.outputs.has_changes == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        RELEASE_NAME="${{ steps.version.outputs.release_name }}"
        
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        # æ„å»ºä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
        ASSETS="${RELEASE_NAME}.zip"
        
        # æ·»åŠ æœ‰å˜åŒ–çš„ m3u æ–‡ä»¶
        if [ "${{ steps.check_changes.outputs.unicast_changed }}" == "true" ]; then
          ASSETS="$ASSETS unicast.m3u"
        fi
        
        if [ "${{ steps.check_changes.outputs.multicast_r2h_changed }}" == "true" ]; then
          ASSETS="$ASSETS multicast-r2h.m3u"
        fi
        
        if [ "${{ steps.check_changes.outputs.multicast_nofcc_changed }}" == "true" ]; then
          ASSETS="$ASSETS multicast-nofcc.m3u"
        fi
        
        echo "Uploading assets: $ASSETS"
        
        # æ„å»º release notes
        NOTES="ğŸ“… æ›´æ–°æ—¶é—´: $BEIJING_TIME"
        NOTES="$NOTES\n\nğŸ“ æœ¬æ¬¡æ›´æ–°çš„æ–‡ä»¶:"
        
        if [ "${{ steps.check_changes.outputs.unicast_changed }}" == "true" ]; then
          NOTES="$NOTES\n- unicast.m3u"
        fi
        
        if [ "${{ steps.check_changes.outputs.multicast_r2h_changed }}" == "true" ]; then
          NOTES="$NOTES\n- multicast-r2h.m3u"
        fi
        
        if [ "${{ steps.check_changes.outputs.multicast_nofcc_changed }}" == "true" ]; then
          NOTES="$NOTES\n- multicast-nofcc.m3u"
        fi
        
        # åˆ›å»º Release
        gh release create "$RELEASE_NAME" \
          --title "$RELEASE_NAME" \
          --notes "$(echo -e "$NOTES")" \
          --latest \
          $ASSETS
